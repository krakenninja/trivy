#!/bin/sh

TRIVY_BIN_DIR="/usr/local/bin"
TRIVY_BIN_FILE="trivy"
TRIVY_BIN_FILE_PATH=$TRIVY_BIN_DIR"/"$TRIVY_BIN_FILE
if [ ! -f "$TRIVY_BIN_FILE_PATH" ]; then
    TRIVY_VERSION_JSON=$(wget -qO- $TRIVY_SERVER_SERVICE_VER_ENDPOINT)
    TRIVY_VERSION=$(echo $TRIVY_VERSION_JSON | grep 'Version' | sed 's/.*"Version" *: *"\([^"]*\)".*/\1/')
    OS_ARCH=$(uname -m)
    if [[ "$OS_ARCH" == "x86_64" ]]; then
        PACKAGE_ARCH="trivy_"$TRIVY_VERSION"_Linux-64bit.tar.gz"
    elif [[ "$OS_ARCH" == "aarch64" ]]; then
        PACKAGE_ARCH="trivy_"$TRIVY_VERSION"_Linux-ARM64.tar.gz"
    else
        echo "ERROR : Unknown/unsupported architecture [$OS_ARCH]"
        exit 1
    fi
    
    # prepare the trivy download URL
    TRIVY_DOWNLOAD_URL="https://github.com/aquasecurity/trivy/releases/download/v"$TRIVY_VERSION"/"$PACKAGE_ARCH
    echo "INFO : Get trivy binary [$TRIVY_DOWNLOAD_URL]"
    
    wget -qO- $TRIVY_DOWNLOAD_URL \
        | tar zxvf - -C $TRIVY_BIN_DIR $TRIVY_BIN_FILE \
        && chmod +x $TRIVY_BIN_FILE_PATH
    if [ "$?" != "0" ]; then
        echo "ERROR : Unable to get trivy binary [$TRIVY_DOWNLOAD_URL]"
        exit 1
    fi
    
    # making sure we have the file exist
    if [ ! -f "$TRIVY_BIN_FILE_PATH" ]; then
        echo "ERROR : trivy binary not found at path [$TRIVY_BIN_FILE_PATH]"
        exit 1
    fi
fi

# start the server
http-server /app/dist